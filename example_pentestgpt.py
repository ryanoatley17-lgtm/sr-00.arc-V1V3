#!/usr/bin/env python3
"""
PentestGPT Framework Examples
Demonstrates various usage patterns of the PentestGPT framework
"""

from pentestgpt import (
    PentestGPT,
    OWASPKnowledgeBase,
    ChainOfThought,
    TaskType
)
from pentestgpt_tools import (
    ToolRegistry,
    NmapWrapper,
    ToolCommandGenerator
)


def example_1_basic_session():
    """
    Example 1: Basic penetration testing session
    """
    print("=" * 80)
    print("EXAMPLE 1: Basic Penetration Testing Session")
    print("=" * 80)

    # Initialize PentestGPT
    pentest = PentestGPT()

    # Setup session (in real scenario, user would provide these)
    pentest.initialize_session(
        target='192.168.1.100',
        target_type='ip',
        scope='Single host authorized for internal testing'
    )

    # Simulate authorization confirmation
    pentest.authorization_confirmed = True
    print("âœ“ Authorization confirmed (simulated for example)")

    # Build standard task tree
    pentest.build_standard_ptt()

    print("\nTask Tree Created:")
    print(pentest.ptt.print_tree())

    # Get first recommendation
    print("\n" + "=" * 80)
    print("Getting next recommendation...")
    recommendation = pentest.get_next_recommendation()
    print(recommendation)

    # Simulate executing first task and adding findings
    first_task = pentest.ptt.get_next_task()
    if first_task:
        print(f"\nâœ“ Simulating execution of {first_task.id}")

        # Add some simulated findings
        pentest.ptt.add_finding(
            first_task.id,
            "Target responds to ping (ICMP echo)"
        )
        pentest.ptt.add_finding(
            first_task.id,
            "Reverse DNS: server01.example.local"
        )

        # Mark as completed
        pentest.ptt.update_task_status(first_task.id, TaskStatus.COMPLETED)
        print(f"âœ“ Task {first_task.id} completed with 2 findings")

    # Save session
    session_file = '/tmp/pentest_example1.json'
    pentest.save_session(session_file)

    print(f"\n{'=' * 80}")
    print("Example 1 Complete!")
    print(f"{'=' * 80}\n")


def example_2_owasp_knowledge():
    """
    Example 2: Using OWASP Knowledge Base
    """
    print("=" * 80)
    print("EXAMPLE 2: OWASP Top 10 Knowledge Base")
    print("=" * 80)

    # List all categories
    print("\nOWASP Top 10 2021 Categories:")
    for cat_id in OWASPKnowledgeBase.list_all_categories():
        cat = OWASPKnowledgeBase.get_owasp_info(cat_id)
        print(f"  {cat_id}: {cat['name']}")

    # Get specific vulnerability details
    print("\n" + "=" * 80)
    print("SQL Injection (A03:2021) Details:")
    print("=" * 80)

    sql_injection = OWASPKnowledgeBase.get_owasp_info('A03:2021')
    print(f"\nName: {sql_injection['name']}")
    print(f"Description: {sql_injection['description']}")

    print("\nExamples:")
    for example in sql_injection['examples']:
        print(f"  â€¢ {example}")

    print("\nTest Methods:")
    for method in sql_injection['test_methods']:
        print(f"  â€¢ {method}")

    print(f"\nRelated CWEs: {', '.join(sql_injection['cwe'])}")

    # Search by keyword
    print("\n" + "=" * 80)
    print("Searching for 'authentication' vulnerabilities:")
    print("=" * 80)

    results = OWASPKnowledgeBase.search_by_keyword('authentication')
    for cat_id, cat_data in results:
        print(f"\n{cat_id}: {cat_data['name']}")
        print(f"  {cat_data['description']}")

    print(f"\n{'=' * 80}")
    print("Example 2 Complete!")
    print(f"{'=' * 80}\n")


def example_3_chain_of_thought():
    """
    Example 3: Chain-of-Thought Reasoning
    """
    print("=" * 80)
    print("EXAMPLE 3: Chain-of-Thought Reasoning")
    print("=" * 80)

    # Reconnaissance reasoning
    print("\nScenario: Planning reconnaissance for web application")
    reasoning = ChainOfThought.reason_reconnaissance(
        target='https://example.com',
        target_type='web'
    )
    print(reasoning)

    # Scanning reasoning
    print("\n" + "=" * 80)
    print("Scenario: Planning network scanning")
    reasoning = ChainOfThought.reason_scanning(
        target='192.168.1.0/24',
        recon_data={'discovered_hosts': 15}
    )
    print(reasoning)

    # Vulnerability analysis reasoning
    print("\n" + "=" * 80)
    print("Scenario: Analyzing discovered services")
    services = [
        {'port': 22, 'service': 'ssh', 'version': 'OpenSSH 7.4'},
        {'port': 80, 'service': 'http', 'version': 'Apache 2.4.41'},
        {'port': 3306, 'service': 'mysql', 'version': 'MySQL 5.7.32'}
    ]
    reasoning = ChainOfThought.reason_vulnerability_analysis(services)
    print(reasoning)

    print(f"\n{'=' * 80}")
    print("Example 3 Complete!")
    print(f"{'=' * 80}\n")


def example_4_tool_integration():
    """
    Example 4: Tool Integration and Command Generation
    """
    print("=" * 80)
    print("EXAMPLE 4: Tool Integration")
    print("=" * 80)

    # Check installed tools
    print("\nChecking installed pentesting tools:")
    registry = ToolRegistry()
    installations = registry.check_installations()

    for tool, installed in installations.items():
        status = "âœ“ Installed" if installed else "âœ— Not installed"
        print(f"  {tool}: {status}")

    # Generate reconnaissance commands
    print("\n" + "=" * 80)
    print("Generating reconnaissance commands for example.com:")
    print("=" * 80)

    commands = ToolCommandGenerator.generate_recon_commands('example.com', 'domain')
    for i, cmd in enumerate(commands, 1):
        print(f"  {i}. {cmd}")

    # Generate web application commands
    print("\n" + "=" * 80)
    print("Generating web application testing commands:")
    print("=" * 80)

    commands = ToolCommandGenerator.generate_web_commands('https://example.com')
    for i, cmd in enumerate(commands, 1):
        print(f"  {i}. {cmd}")

    # Generate service-specific enumeration
    print("\n" + "=" * 80)
    print("Generating HTTP service enumeration commands:")
    print("=" * 80)

    commands = ToolCommandGenerator.generate_enumeration_commands(
        target='192.168.1.100',
        service='http',
        port=80
    )
    for i, cmd in enumerate(commands, 1):
        print(f"  {i}. {cmd}")

    print(f"\n{'=' * 80}")
    print("Example 4 Complete!")
    print(f"{'=' * 80}\n")


def example_5_custom_task_tree():
    """
    Example 5: Custom Task Tree for Web Application Test
    """
    print("=" * 80)
    print("EXAMPLE 5: Custom Task Tree for Web Application")
    print("=" * 80)

    pentest = PentestGPT()
    pentest.initialize_session(
        target='https://webapp.example.com',
        target_type='web',
        scope='Web application and API endpoints'
    )
    pentest.authorization_confirmed = True

    # Create custom task tree for web app
    print("\nBuilding custom task tree...")

    # Phase 1: Information Gathering
    recon = pentest.ptt.add_task(
        "Web Application Reconnaissance",
        TaskType.RECONNAISSANCE,
        description="Gather information about the web application"
    )

    pentest.ptt.add_task(
        "Technology Stack Identification",
        TaskType.RECONNAISSANCE,
        parent_id=recon.id,
        commands=[
            "whatweb https://webapp.example.com",
            "wappalyzer https://webapp.example.com"
        ]
    )

    pentest.ptt.add_task(
        "Subdomain Enumeration",
        TaskType.RECONNAISSANCE,
        parent_id=recon.id,
        commands=[
            "amass enum -d example.com",
            "subfinder -d example.com"
        ]
    )

    # Phase 2: Content Discovery
    content = pentest.ptt.add_task(
        "Content Discovery",
        TaskType.ENUMERATION,
        description="Discover hidden files, directories, and endpoints"
    )

    pentest.ptt.add_task(
        "Directory Bruteforcing",
        TaskType.ENUMERATION,
        parent_id=content.id,
        commands=[
            "dirb https://webapp.example.com",
            "gobuster dir -u https://webapp.example.com -w wordlist.txt"
        ]
    )

    pentest.ptt.add_task(
        "API Endpoint Discovery",
        TaskType.ENUMERATION,
        parent_id=content.id,
        commands=[
            "Check /api, /v1, /v2 endpoints",
            "Review JavaScript files for API endpoints"
        ]
    )

    # Phase 3: Vulnerability Testing
    vuln = pentest.ptt.add_task(
        "OWASP Top 10 Testing",
        TaskType.VULNERABILITY_ANALYSIS,
        description="Test for common web vulnerabilities"
    )

    pentest.ptt.add_task(
        "Injection Testing",
        TaskType.VULNERABILITY_ANALYSIS,
        parent_id=vuln.id,
        description="Test for SQL, NoSQL, Command injection",
        commands=[
            "sqlmap -u 'https://webapp.example.com/page?id=1'",
            "Test input fields with payloads: ' OR '1'='1"
        ]
    )

    pentest.ptt.add_task(
        "Authentication Testing",
        TaskType.VULNERABILITY_ANALYSIS,
        parent_id=vuln.id,
        description="Test authentication and session management",
        commands=[
            "Test for default credentials",
            "Analyze session tokens for randomness",
            "Test password reset functionality"
        ]
    )

    pentest.ptt.add_task(
        "Access Control Testing",
        TaskType.VULNERABILITY_ANALYSIS,
        parent_id=vuln.id,
        description="Test for broken access control",
        commands=[
            "Test horizontal privilege escalation",
            "Test vertical privilege escalation",
            "Check for IDOR vulnerabilities"
        ]
    )

    # Display the custom tree
    print("\nCustom Web Application Task Tree:")
    print(pentest.ptt.print_tree())

    print(f"\n{'=' * 80}")
    print("Example 5 Complete!")
    print(f"{'=' * 80}\n")


def example_6_report_generation():
    """
    Example 6: Report Generation
    """
    print("=" * 80)
    print("EXAMPLE 6: Report Generation")
    print("=" * 80)

    # Create a sample pentest session with findings
    pentest = PentestGPT()
    pentest.initialize_session(
        target='192.168.1.100',
        target_type='ip',
        scope='Internal host - full penetration test'
    )
    pentest.authorization_confirmed = True

    # Add some tasks and findings
    task1 = pentest.ptt.add_task(
        "Port Scanning",
        TaskType.SCANNING,
        commands=["nmap -sS -sV 192.168.1.100"]
    )
    pentest.ptt.update_task_status(task1.id, TaskStatus.COMPLETED)
    pentest.ptt.add_finding(task1.id, "Port 22/tcp open - OpenSSH 7.4")
    pentest.ptt.add_finding(task1.id, "Port 80/tcp open - Apache 2.4.41")
    pentest.ptt.add_finding(task1.id, "Port 3306/tcp open - MySQL 5.7.32")

    task2 = pentest.ptt.add_task(
        "Vulnerability Scanning",
        TaskType.VULNERABILITY_ANALYSIS,
        commands=["nmap --script vuln 192.168.1.100"]
    )
    pentest.ptt.update_task_status(task2.id, TaskStatus.COMPLETED)
    pentest.ptt.add_finding(
        task2.id,
        "CVE-2021-41773 - Apache 2.4.41 path traversal vulnerability"
    )

    task3 = pentest.ptt.add_task(
        "Web Application Testing",
        TaskType.VULNERABILITY_ANALYSIS,
        commands=["nikto -h http://192.168.1.100"]
    )
    pentest.ptt.update_task_status(task3.id, TaskStatus.COMPLETED)
    pentest.ptt.add_finding(task3.id, "Missing security headers (X-Frame-Options)")
    pentest.ptt.add_finding(task3.id, "Directory listing enabled on /uploads")

    # Add findings to the main list
    pentest.findings = [
        {'task_id': task1.id, 'finding': 'Port 22/tcp open - OpenSSH 7.4', 'timestamp': '2024-01-15T10:00:00'},
        {'task_id': task1.id, 'finding': 'Port 80/tcp open - Apache 2.4.41', 'timestamp': '2024-01-15T10:00:01'},
        {'task_id': task1.id, 'finding': 'Port 3306/tcp open - MySQL 5.7.32', 'timestamp': '2024-01-15T10:00:02'},
        {'task_id': task2.id, 'finding': 'CVE-2021-41773 - Apache 2.4.41 path traversal vulnerability', 'timestamp': '2024-01-15T10:15:00'},
        {'task_id': task3.id, 'finding': 'Missing security headers (X-Frame-Options)', 'timestamp': '2024-01-15T10:30:00'},
        {'task_id': task3.id, 'finding': 'Directory listing enabled on /uploads', 'timestamp': '2024-01-15T10:30:30'},
    ]

    # Generate report
    report = pentest.generate_report()
    print(report)

    print(f"\n{'=' * 80}")
    print("Example 6 Complete!")
    print(f"{'=' * 80}\n")


def main():
    """Run all examples"""
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     PentestGPT Framework Examples                            â•‘
â•‘                   Demonstrating Key Features and Usage                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

These examples demonstrate the PentestGPT framework capabilities.
All examples use simulated data for demonstration purposes.

âš ï¸  Remember: Only use this framework with proper authorization! âš ï¸

""")

    import sys
    from datetime import datetime

    # Import TaskStatus
    from pentestgpt import TaskStatus

    examples = [
        ("Basic Session", example_1_basic_session),
        ("OWASP Knowledge Base", example_2_owasp_knowledge),
        ("Chain-of-Thought Reasoning", example_3_chain_of_thought),
        ("Tool Integration", example_4_tool_integration),
        ("Custom Task Tree", example_5_custom_task_tree),
        ("Report Generation", example_6_report_generation)
    ]

    print("Available Examples:")
    for i, (name, _) in enumerate(examples, 1):
        print(f"  {i}. {name}")
    print(f"  {len(examples) + 1}. Run All Examples")

    try:
        choice = input("\nSelect example (1-{}): ".format(len(examples) + 1)).strip()

        if choice == str(len(examples) + 1):
            # Run all examples
            for name, example_func in examples:
                print("\n" * 2)
                example_func()
                input("Press Enter to continue to next example...")
        elif choice.isdigit() and 1 <= int(choice) <= len(examples):
            # Run selected example
            _, example_func = examples[int(choice) - 1]
            example_func()
        else:
            print("Invalid choice. Running all examples...")
            for name, example_func in examples:
                print("\n" * 2)
                example_func()

    except KeyboardInterrupt:
        print("\n\nExamples interrupted by user.")
        sys.exit(0)

    print("\n" + "=" * 80)
    print("All examples completed!")
    print("=" * 80)
    print("\nNext steps:")
    print("  â€¢ Try the interactive CLI: python3 pentestgpt_cli.py")
    print("  â€¢ Read the documentation: PENTESTGPT_README.md")
    print("  â€¢ Build your own custom workflows")
    print("\nHappy (ethical) hacking! ğŸ›¡ï¸")


if __name__ == "__main__":
    main()
